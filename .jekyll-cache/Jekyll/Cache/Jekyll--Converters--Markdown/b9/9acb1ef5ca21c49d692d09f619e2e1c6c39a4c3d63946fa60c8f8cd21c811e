I"s><p><em>Real world PV data is often messy. In this post I show some methods I’ve developed as part of my research to handle messy PV data.</em></p>

<h3 id="introduction-good-and-bad-pv-data">Introduction: good and bad PV data</h3>

<p>When we think of <a href="https://en.wikipedia.org/wiki/Photovoltaics">photovoltaic</a> (PV) system power data, we often think of something like this:</p>

<p><img src="http://localhost:4000/assets/DataCleaning_8_0.png" alt="png" /></p>

<p>We expect to see a daily pulse, starting from zero watts just before sunrise and returning to zero watts just after sunset. It should have a peak somewhere around the middle of the day. Sometimes that pulse is “corrupted” by the effects of clouds, as seen in the first and third days above. In addition, we typically assume that the data is being measured at regular intervals, such as every minute or every five minutes. The data we see is an accurate reflection of what the system did at that time.</p>

<p>However, the reality is that many data sets deviate from these expectations in a number of ways. You might have:</p>

<ul>
  <li>Missing data, both during the day and at night</li>
  <li>Changing or irregular measurement intervals</li>
  <li>Changes in local clock time (time shifts)</li>
</ul>

<p>Data can be missing for many reasons. For example, a data acquisition system may go offline for a few hours and fail to collect data while the system is producing power. Alternatively, it is not uncommon for some data acquisition systems to simply stop collecting data when the sun goes down, and both issues might happen in the same data set.</p>

<p>Similarly, there can be multiple causes of changing or irregular measurement intervals. On the one hand, you might have a data logger that was commissioned with a 5 minute aggregation period, which was later changed to be a 1 minute aggregation period.* On the other hand, you can have individual “skipped scans,” in which single timestamps are missing or delayed.</p>

<p>Continuing the theme, the recorded time can appear to shift suddenly relative to the underlying physical processes for a number of reasons. A common one is mishandling of daylight saving’s time shifts. However, it is also not uncommon for a datalogger to simply have it’s internal clock changed for some reason.</p>

<hr />
<p>* Most data loggers provide built in functions for measuring at a high scan rate, like every 5 seconds, but then only storing rolled up statistics, such as 1 or 5 minute averages.</p>

<h3 id="data-cleaning-preparing-for-analysis">Data cleaning: preparing for analysis</h3>

<p>Fundamentally, if a data set is too corrupted by the types of errors described above, it will not be possible to extract useful information from that data set. But for moderately corrupted data sets, we want to clean up these types of errors so that we can then analyze the data, such as to estimate overall system degradation or look for loss factors. I am particularly interested in methods that automate this process.</p>

<p>In this post, I am presenting recent work on fixing common PV data errors automatically with Python. All this is open-source under a <a href="https://github.com/slacgismo/solar-data-tools/blob/master/LICENSE">BSD 2-Clause License</a>. You can find the (most up to date) code here: <a href="https://github.com/slacgismo/solar-data-tools">https://github.com/slacgismo/solar-data-tools</a>. We also have PyPI and Conda releases.</p>

<p>In this post, I’ll show some example data sets to illustrate the difference between clean and messy data. The data we’ll be using is provided free by NREL as the <a href="https://developer.nrel.gov/docs/solar/pvdaq-v3/">PVDAQ service</a>. You can get an <a href="https://developer.nrel.gov/docs/api-key/">API key here</a>. Also in the <code class="highlighter-rouge">solardatatools</code> package is a wrapper over the PVDAQ API, which we’ll use in this post to get our data.</p>

<h3 id="data-example-mostly-clean">Data example: (mostly) clean</h3>

<p>Let’s start by taking a look at a relatively “clean” data set.  We’ll start by importing the functions we’ll need from <code class="highlighter-rouge">solardatatools</code> (and <code class="highlighter-rouge">pandas</code>).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">solardatatools</span> <span class="kn">import</span> <span class="n">get_pvdaq_data</span><span class="p">,</span> <span class="n">standardize_time_axis</span><span class="p">,</span> <span class="n">make_2d</span><span class="p">,</span> <span class="n">plot_2d</span><span class="p">,</span> <span class="n">fix_time_shifts</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span></code></pre></figure>

<p>Next, we load our API key for PVDAQ</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">'~'</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">home</span> <span class="o">+</span> <span class="s">'/.api_keys/nrel.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span></code></pre></figure>

<p>Next, we make our API request for data at a site in the PVDAQ database. You can find a searchable map with site IDs <a href="https://maps.nrel.gov/pvdaq/?aL=zNVfnk%255Bv%255D%3Dt&amp;bL=clight&amp;cE=0&amp;lR=0&amp;mC=40.21244%2C-91.625976&amp;zL=4">here</a>. I’m picking site <code class="highlighter-rouge">35</code> because I know it to be a good data set.</p>

<p>The PVDAQ API provides a number of ways to access the data, but my prefered approach (and the one that is implemented in my wrapper), is the <em>yearly CSV file API</em>. This returns a full year of high-resultion data for a site from a single request and is the fasted way to get a large amount of high-frequency data from the service. To get multiple years of data, multiple API requests must be generated. As shown below, the wrapper from <code class="highlighter-rouge">solardatatools</code> automates this process.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df1</span> <span class="o">=</span> <span class="n">get_pvdaq_data</span><span class="p">(</span><span class="n">sysid</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="p">[</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">2012</span><span class="p">,</span> <span class="mi">2013</span><span class="p">],</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[</span><span class="o">============================================================</span><span class="p">]</span> <span class="mf">100.0</span><span class="o">%</span> <span class="o">...</span><span class="n">queries</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">6.3</span> <span class="n">seconds</span>       </code></pre></figure>

<p>The wrapper returns a <code class="highlighter-rouge">pandas</code> data frame. We can view the time-series power data as follows.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">df1</span><span class="p">[</span><span class="s">'Date-Time'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s">'Date-Time'</span><span class="p">])</span>
<span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Date-Time'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1150</span><span class="p">:</span><span class="mi">1450</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s">'dc_power'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_8_0.png" alt="png" /></p>

<p>And now we see where the image at the top of the post came from. But this is just a few days in January. How do we get a feel for the whole data set at once. Well, we could try just plotting the whole thing…</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">df1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s">'dc_power'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_10_0.png" alt="png" /></p>

<p>…but that’s not overly helpful. We can see a little bit of the seasonal structure in the data, but we have no real sense of the quality of the data.</p>

<p>For this reason, I prefer to look at the data in “2-D form”. In other words, form a 2-D array (or matrix) where each column is 1 day of data from the data set. Then, we can view the entire data set at once as an image, where the pixel intensity is mapped to the power output.</p>

<p>How do we go about doing that? Well, if we know the number of samples collected in each day, then we can use numpy to reshape the 1-D array into the correct 2-D shape. So, let’s start by taking a look at a few rows of data in the data frame.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df1</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></figure>

<div>
<style scoped="">
    .dataframe {
        border-collapse: separate;
        border-spacing: 20px 0;
    }
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: middle;
        text-align: middle;
    }

    .dataframe tbody tr td {
        vertical-align: middle;
        text-align: middle;
    }

    .dataframe thead th {
        text-align: middle;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Date-Time</th>
      <th>SiteID</th>
      <th>ac_current</th>
      <th>ac_power</th>
      <th>ac_voltage</th>
      <th>ambient_temp</th>
      <th>dc_current</th>
      <th>dc_power</th>
      <th>dc_voltage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2011-01-01 00:00:00</th>
      <td>35</td>
      <td>0.0</td>
      <td>-200.0</td>
      <td>284.0</td>
      <td>-3.353332</td>
      <td>-3.0</td>
      <td>-200.0</td>
      <td>18.0</td>
    </tr>
    <tr>
      <th>2011-01-01 00:15:00</th>
      <td>35</td>
      <td>0.0</td>
      <td>-200.0</td>
      <td>284.0</td>
      <td>-3.381110</td>
      <td>-4.0</td>
      <td>-200.0</td>
      <td>18.0</td>
    </tr>
    <tr>
      <th>2011-01-01 00:30:00</th>
      <td>35</td>
      <td>0.0</td>
      <td>-300.0</td>
      <td>284.0</td>
      <td>-3.257777</td>
      <td>-3.0</td>
      <td>0.0</td>
      <td>17.0</td>
    </tr>
    <tr>
      <th>2011-01-01 00:45:00</th>
      <td>35</td>
      <td>0.0</td>
      <td>-300.0</td>
      <td>284.0</td>
      <td>-3.296666</td>
      <td>-3.0</td>
      <td>-200.0</td>
      <td>17.0</td>
    </tr>
    <tr>
      <th>2011-01-01 01:00:00</th>
      <td>35</td>
      <td>0.0</td>
      <td>-300.0</td>
      <td>284.0</td>
      <td>-3.426110</td>
      <td>-3.0</td>
      <td>-200.0</td>
      <td>16.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>We see that the data in our table is measured every <code class="highlighter-rouge">15</code> minutes. That means that there should be</p>

<script type="math/tex; mode=display">\frac{24 \times 60}{15} = 96</script>

<p>measurements in each day. So, let’s give that a shot.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">power_matrix</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s">'dc_power'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">'F'</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="c1"># convert W to kW
</span><span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Something failed:'</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Something</span> <span class="n">failed</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">reshape</span> <span class="n">array</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">105088</span> <span class="n">into</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">96</span><span class="p">,</span><span class="n">newaxis</span><span class="p">)</span></code></pre></figure>

<p>Huh, that didn’t work. Why not?</p>

<p>Well, the data frame that we got from PVDAQ has <code class="highlighter-rouge">105088</code> rows, and <code class="highlighter-rouge">96</code> does not go into that number evenly.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="mi">105088</span> <span class="o">/</span> <span class="mi">96</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="mf">1094.6666666666667</span></code></pre></figure>

<p>Hmmm… well we could try just removing some rows. If we remove <code class="highlighter-rouge">64</code> rows from the table, then we would have <code class="highlighter-rouge">105024</code> rows, which is a multiple of <code class="highlighter-rouge">96</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">power_matrix</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s">'dc_power'</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">105024</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">'F'</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="c1"># convert W to kW</span></code></pre></figure>

<p>Well, that seemed to work. Let’s try viewing the matrix we created.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">plot_2d</span><span class="p">(</span><span class="n">power_matrix</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_20_0.png" alt="png" /></p>

<p>Oh boy, we seem to have a problem. Things start out okay for the first <code class="highlighter-rouge">250</code> days or so, but then after that, we get some wild shifts in the alignment of the days. The issue here is gaps in the data. When we are missing timestamps, we no longer have exactly <code class="highlighter-rouge">96</code> rows for each day. The way to fix this is to <em>standardize the time axis</em>. This is a process of generating a correct time axis, with exactlty <code class="highlighter-rouge">96</code> measurements each day, and then aligning the available data to fit the newly generated time stamps as closely as possible.</p>

<p>The function <code class="highlighter-rouge">standardize_time_axis</code> from <code class="highlighter-rouge">solardatatools</code> performs this work for you, automatically detecting the correct frequency of data points, generating a new time axis, and filling in the data.</p>

<p>In addition, the function <code class="highlighter-rouge">make_2d</code> automatically detects the correct number of data points in each day and constructs the 2-D array. Note that while this data set has <code class="highlighter-rouge">96</code> measurements per day, a data set with 1-minute data would have <code class="highlighter-rouge">1440</code> measurements per day.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df1</span> <span class="o">=</span> <span class="n">standardize_time_axis</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
<span class="n">power_matrix_raw1</span> <span class="o">=</span> <span class="n">make_2d</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'dc_power'</span><span class="p">,</span> <span class="n">zero_nighttime</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">interp_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">power_matrix_raw1</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_22_0.png" alt="png" /></p>

<p>And now, having correctly aligned the measurements, we finally get our first glimpse of the overall data set. The seasonal variation over the three years captured by the data is clearly visible. The white parts of the gaps in the data introduced by the standardization of the time axis. Now the caps in our data are clearly visible; we know exactly when they occur in the data set.</p>

<p>Despite these gaps, this is would still be considered a very clean data set. This is “good data.” There aren’t many gaps and we see a nice, clean daily pulse, than changes slowly from day-to-day, as the seasons change. If we wanted to, we could fill the missing data with zeros, and move on with our analysis.</p>

<p>But clean data isn’t what this post is about. This post is about…</p>

<h2 id="data-example-messy">Data example: messy</h2>

<p>Let’s take a look at another system in the PVDAQ database, shall we? This time, we’ll use the flag <code class="highlighter-rouge">standardize=True</code> to automatically standardize the time axis after collecting the data from the server.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">get_pvdaq_data</span><span class="p">(</span><span class="n">sysid</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="p">[</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">2012</span><span class="p">,</span> <span class="mi">2013</span><span class="p">],</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[</span><span class="o">============================================================</span><span class="p">]</span> <span class="mf">100.0</span><span class="o">%</span> <span class="o">...</span><span class="n">queries</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">13.0</span> <span class="n">seconds</span>       </code></pre></figure>

<p>Okay, the time axis standardization is taken care of. Let’s take a look at what we got.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">power_matrix_raw</span> <span class="o">=</span> <span class="n">make_2d</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'dc_power'</span><span class="p">,</span> <span class="n">zero_nighttime</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">interp_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">power_matrix_raw</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_26_0.png" alt="png" /></p>

<p>That is definitely not as clean as the previous data set. For starters, we can see that we are completely missing nighttime data. Recall that the white space is introduced by the time axis standardization step. As with the previous example, this step put the data in the “corect place” so that we can view the data as a 2-D image.</p>

<p>But this data set has a number of other problems. The first year of data has a lot of holes that all seem to occur at the same time each day, resulting in a banded pattern. This is due to the first year being aggregated at lower frequency (every 15 minutes) than the subsequent two years (every 5 minutes). The time standardization step has created blank space between the measurements, so that they line up with the subsequent years. There are also large, multi-day gaps in data throughout the second two years. Finally, we can see that there are shifts each year due to daylight savings time. This one has it all!</p>

<p>The first thing we’ll do is fill in nighttime data with zero values. The <code class="highlighter-rouge">make_2d</code> function has a keyword arguement <code class="highlighter-rouge">zero_nighttime</code> which we set to <code class="highlighter-rouge">True</code>. This will have the function attempt to detect missing values associated with the nighttime, and fill them with zeros, as seen below.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">power_matrix_night</span> <span class="o">=</span> <span class="n">make_2d</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'dc_power'</span><span class="p">,</span> <span class="n">zero_nighttime</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">interp_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">power_matrix_night</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_28_0.png" alt="png" /></p>

<p>Notebly, this method does not fill in the missing values associated with the low data rate in the first year. It does, however, fill in the large, multiday gaps in the second and third years, which is fine. We have no idea what happened on those days anyway.</p>

<p>Now let’s deal with the missing data in the first year. The keyword arguement <code class="highlighter-rouge">interp_missing</code> will fill the remaining gaps in the data using a linear interpolation.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">power_matrix_fill</span> <span class="o">=</span> <span class="n">make_2d</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'dc_power'</span><span class="p">,</span> <span class="n">zero_nighttime</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">interp_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">power_matrix_fill</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_30_0.png" alt="png" /></p>

<p>There are no longer any gaps in the data! We also see that the sunrise and sunset times have been cleaned up, removing that “white boarder” around the non-zero data.</p>

<p>Finally, we use the function <code class="highlighter-rouge">fix_time_shifts</code> from <code class="highlighter-rouge">solardatatools</code> to automatically detect the points in the data set where a time shift has occured and remove the shifts. This approach is based on some fancy math that is the subject of an upcoming paper. The algorithm can be run on any data set, and it will correctly do nothing if no shifts are detected.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">power_matrix_clean</span> <span class="o">=</span> <span class="n">fix_time_shifts</span><span class="p">(</span><span class="n">power_matrix_fill</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">power_matrix_clean</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_32_0.png" alt="png" /></p>

<p>There we have it! While not still not as clean as the first data set we looked at, we can make make out a distinct 3-year PV power signal. Despite the remaining corruption, we can see a clear periodicity on a yearly cycle. The system is experiencing morning shade in the summer and most likely some evening shade in the winter.</p>

<h2 id="analysis-example-fitting-a-clear-sky-baseline">Analysis example: fitting a clear sky baseline</h2>

<p>Last year, I <a href="https://www.researchgate.net/publication/332929283_Statistical_Clear_Sky_Fitting_Algorithm">wrote a paper</a> on using <a href="https://web.stanford.edu/~boyd/papers/glrm.html">Generalized Low Rank Models</a> (GLRM) to fit a clear sky baseline to PV power data. This provides an estimation of the power output of the system under clear sky conditions for any day in the data set. The method requires no physical model of the site or system, <a href="https://www.e-education.psu.edu/eme810/node/544">unique for clear sky models</a>. The difference is that this is a <em>descriptive</em> (or data-driven) model rather than a <em>predictive</em> model.</p>

<p>This model is useful for a number of reasons. It is a baseline of system behavior, so deviations from that baseline can typically be thought of as the impact of clouds and the weather on system power output. Soiling signals are also visible as deviations from this baseline. Subtracting this baseline from the measured data is useful for training statistical forecasting models. The clear sky model additionally provides an estimate of the long-term, year-over-year degradation rate of the system, a task that typically requires a predictive model and on-site irradiance and weather data.</p>

<p>As we will see below, we are able to fit this statistical clear sky model to our freshly cleaned data set. This algorithm requires the data to be in a clean 2-D array form. So, the 2-D formulation of the data is useful for both viewing the data and for model fitting. In fact, that visually noticable yearly periodicity and seasonal structure is exactly what the GLRM picks up on in the data.</p>

<p>With that, let’s fit the clear sky model. First some imports from <code class="highlighter-rouge">StatiscialClearSky</code>: <a href="https://github.com/slacgismo/StatisticalClearSky">https://github.com/slacgismo/StatisticalClearSky</a>. This code is also available on PyPI and Conda.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">home</span> <span class="o">+</span> <span class="s">'/Documents/ClearSky/StatisticalClearSky/'</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">statistical_clear_sky.algorithm.iterative_fitting</span> <span class="kn">import</span> <span class="n">IterativeFitting</span>
<span class="kn">from</span> <span class="nn">statistical_clear_sky.solver_type</span> <span class="kn">import</span> <span class="n">SolverType</span></code></pre></figure>

<p>Next we set up the fitting object. It is instantiated with the cleaned power matix, along with keyword arguements defining the rank of the low-rank model and the convex solver to use to solve the underlying mathematical problems in the algorithm. Information on Mosek is avaible here: <a href="https://www.mosek.com/">https://www.mosek.com/</a></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit</span> <span class="o">=</span> <span class="n">IterativeFitting</span><span class="p">(</span><span class="n">power_matrix_clean</span><span class="p">,</span> <span class="n">rank_k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">solver_type</span><span class="o">=</span><span class="n">SolverType</span><span class="o">.</span><span class="n">mosek</span><span class="p">)</span></code></pre></figure>

<p>Next we execute the algorithm. This fits the clear sky model to the data. It is an iterative algorithm, based on solving a series of convex optimization problems, as detailed in the 2018 paper. An upcoming paper will detail the sensitivity and setting recommendations for the tuning parameters <code class="highlighter-rouge">mu_l</code>, <code class="highlighter-rouge">mu_r</code>, and <code class="highlighter-rouge">tau</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mu_l</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">mu_r</span><span class="o">=</span><span class="mf">5e3</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_iteration</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">obtaining</span> <span class="n">initial</span> <span class="n">value</span> <span class="n">of</span> <span class="n">component</span> <span class="n">r0</span>
<span class="n">obtaining</span> <span class="n">weights</span>
<span class="n">starting</span> <span class="n">at</span> <span class="mf">42550261280.188</span> <span class="p">[</span><span class="mf">8075174.351660941</span><span class="p">,</span> <span class="mf">3084.2335460164554</span><span class="p">,</span> <span class="mf">34297341707.522377</span><span class="p">,</span> <span class="mf">8244841314.080191</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">11773842.904</span> <span class="p">[</span><span class="mf">9.01625132e+06</span> <span class="mf">2.47532200e+03</span> <span class="mf">2.75511614e+06</span> <span class="mf">1.26000000e-01</span><span class="p">]</span>
<span class="n">Caution</span><span class="p">:</span> <span class="n">residuals</span> <span class="n">increased</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">9655058.417</span> <span class="p">[</span><span class="mf">6.64297435e+06</span> <span class="mf">1.99171110e+04</span> <span class="mf">2.99216649e+06</span> <span class="mf">4.66000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">9489574.262</span> <span class="p">[</span><span class="mf">6.36530977e+06</span> <span class="mf">1.84331350e+04</span> <span class="mf">3.10583060e+06</span> <span class="mf">7.63000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">9353330.910</span> <span class="p">[</span><span class="mf">6.09114404e+06</span> <span class="mf">1.92288640e+04</span> <span class="mf">3.24295778e+06</span> <span class="mf">2.24000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">9283065.924</span> <span class="p">[</span><span class="mf">6.01976252e+06</span> <span class="mf">1.90892010e+04</span> <span class="mf">3.24421419e+06</span> <span class="mf">9.00000000e-03</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">9174196.417</span> <span class="p">[</span><span class="mf">5.94212274e+06</span> <span class="mf">1.95049600e+04</span> <span class="mf">3.21256857e+06</span> <span class="mf">1.52000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">7</span><span class="p">:</span> <span class="mf">9104404.945</span> <span class="p">[</span><span class="mf">5.89410158e+06</span> <span class="mf">1.97861860e+04</span> <span class="mf">3.19051717e+06</span> <span class="mf">1.50000000e-02</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">8</span><span class="p">:</span> <span class="mf">9070032.095</span> <span class="p">[</span><span class="mf">5.84999709e+06</span> <span class="mf">1.98316740e+04</span> <span class="mf">3.20020321e+06</span> <span class="mf">1.27000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">9</span><span class="p">:</span> <span class="mf">9048699.751</span> <span class="p">[</span><span class="mf">5.83246334e+06</span> <span class="mf">1.98700870e+04</span> <span class="mf">3.19636626e+06</span> <span class="mf">6.40000000e-02</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">10</span><span class="p">:</span> <span class="mf">9030618.714</span> <span class="p">[</span><span class="mf">5.81798641e+06</span> <span class="mf">2.00405110e+04</span> <span class="mf">3.19259154e+06</span> <span class="mf">2.55000000e-01</span><span class="p">]</span>
<span class="n">Reached</span> <span class="n">iteration</span> <span class="n">limit</span><span class="o">.</span> <span class="n">Previous</span> <span class="n">improvement</span><span class="p">:</span> <span class="mf">0.20</span><span class="o">%</span>
<span class="n">Minimization</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">4.95</span> <span class="n">minutes</span></code></pre></figure>

<p>And now we can view the model that we fit to the data.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">plot_measured_clear</span><span class="p">();</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_40_0.png" alt="png" /></p>

<p>We can convert both the measured data and the clear sky estimate to daily energy by integrating over eachy day. Below, the daily energy as measured by the data acquisition system is shown in blue. Days that were selected as “mostly clear” by the algorithm are highlighted with orange dots. The orange line is the clear sky daily energy as estimated by the algorithm. Note how the orange line approximates a smoothing envelope fit of the orange dots.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">plot_energy</span><span class="p">(</span><span class="n">show_clear</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_42_0.png" alt="png" /></p>

<p>If you compare this fit to that for the clean data, as shown in <a href="#appendix-a-statistical-clear-sky-fitting-on-good-data">Appendix A</a>, you can see that this fit is not quite as
good. However, the results are impressive given the poor state of the underlying data. By applying the data cleaning steps described above, the algorithm is able to pick up on enough of a signal to make a reasonable assesment of this system’s baseline performance. As shown in <a href="#appendix-b-lazy-missing-data-filling">Appendix B</a>, if interpolation is not employed to fill in the data in the first year, the algorithm produces strange, unpredictable results.</p>

<p>We can convert from the 2-D view back to slices of 1-D views. When we do so, we see that the fitted clear sky model accurately tracks the behavior of the system under clear conditions, and interpolates through the cloudy periods.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_44_0.png" alt="png" /></p>

<p>The model even does a reasonable job of following the behavior of the system when it is experiencing morning shade, as shown below.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">205</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_46_0.png" alt="png" /></p>

<p>This behavior is consistent throughout the various seasons and the years.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_48_0.png" alt="png" /></p>

<p>And, the model even provides estimates of the what the clear sky power output of the system should have been, in the periods that are completely missing data.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">    <span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_50_0.png" alt="png" /></p>

<p>The estimated year-over-year degredation rate is returned as a byproduct of model fitting (in this case, basically no evidence of degredation).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">msg</span> <span class="o">=</span> <span class="s">'The system degradation rate is {:.2f}</span><span class="si">%</span><span class="s">'</span>
<span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">clear_sky_fit</span><span class="o">.</span><span class="n">degradation_rate</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">The</span> <span class="n">system</span> <span class="n">degradation</span> <span class="n">rate</span> <span class="ow">is</span> <span class="mf">0.44</span><span class="o">%</span></code></pre></figure>

<h3 id="conclusion">Conclusion</h3>

<p>We’ve seen that the quality of PV power data sets that exist in the real world can very drastically in quality. In the case of highly corrupted data sets, we can still extract useful information from the data by careful cleaning of the data and by using algorithms designed to be robust to missing and bad data. In fact, it is only by careful cleaning and using all available data that we are able to fit a reasonable clear sky model to such a corrupted data set.</p>

<h3 id="acknowledgements">Acknowledgements</h3>

<p>This material is based upon work supported by the U.S. Department of Energy’s Office of Energy Efficiency and Renewable Energy (EERE) under Solar Energy Technologies Office (SETO) Agreement Number 34911.</p>

<h3 id="appendix-a-statistical-clear-sky-fitting-on-good-data">Appendix A: statistical clear sky fitting on good data</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit1</span> <span class="o">=</span> <span class="n">IterativeFitting</span><span class="p">(</span><span class="n">make_2d</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'dc_power'</span><span class="p">,</span> <span class="n">zero_nighttime</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">interp_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                                  <span class="n">rank_k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">solver_type</span><span class="o">=</span><span class="n">SolverType</span><span class="o">.</span><span class="n">mosek</span><span class="p">)</span>
<span class="n">clear_sky_fit1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mu_l</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">mu_r</span><span class="o">=</span><span class="mf">5e3</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_iteration</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">obtaining</span> <span class="n">initial</span> <span class="n">value</span> <span class="n">of</span> <span class="n">component</span> <span class="n">r0</span>
<span class="n">obtaining</span> <span class="n">weights</span>
<span class="n">starting</span> <span class="n">at</span> <span class="mf">33906265296.765</span> <span class="p">[</span><span class="mf">17890865.258460227</span><span class="p">,</span> <span class="mf">10426.906285362822</span><span class="p">,</span> <span class="mf">25677460152.677307</span><span class="p">,</span> <span class="mf">8210903851.923152</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">20978127.870</span> <span class="p">[</span><span class="mf">1.38371398e+07</span> <span class="mf">6.36089000e+03</span> <span class="mf">7.13462711e+06</span> <span class="mf">2.30000000e-02</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">18075047.501</span> <span class="p">[</span><span class="mf">1.11465912e+07</span> <span class="mf">1.68806870e+04</span> <span class="mf">6.91157524e+06</span> <span class="mf">3.40000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">17799930.145</span> <span class="p">[</span><span class="mf">1.09342371e+07</span> <span class="mf">1.58753850e+04</span> <span class="mf">6.84981736e+06</span> <span class="mf">2.94000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">17701226.915</span> <span class="p">[</span><span class="mf">1.08924324e+07</span> <span class="mf">1.65226920e+04</span> <span class="mf">6.79227161e+06</span> <span class="mf">1.63000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">17641001.886</span> <span class="p">[</span><span class="mf">1.08814259e+07</span> <span class="mf">1.60914000e+04</span> <span class="mf">6.74348448e+06</span> <span class="mf">1.26000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">17594734.468</span> <span class="p">[</span><span class="mf">1.08748918e+07</span> <span class="mf">1.58956380e+04</span> <span class="mf">6.70394679e+06</span> <span class="mf">1.92000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">7</span><span class="p">:</span> <span class="mf">17556653.594</span> <span class="p">[</span><span class="mf">1.08746651e+07</span> <span class="mf">1.58112700e+04</span> <span class="mf">6.66617699e+06</span> <span class="mf">2.46000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">8</span><span class="p">:</span> <span class="mf">17523783.849</span> <span class="p">[</span><span class="mf">1.08752142e+07</span> <span class="mf">1.56453940e+04</span> <span class="mf">6.63292424e+06</span> <span class="mf">6.30000000e-02</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">9</span><span class="p">:</span> <span class="mf">17491634.700</span> <span class="p">[</span><span class="mf">1.08688117e+07</span> <span class="mf">1.55948030e+04</span> <span class="mf">6.60722816e+06</span> <span class="mf">7.70000000e-02</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">10</span><span class="p">:</span> <span class="mf">17462459.354</span> <span class="p">[</span><span class="mf">1.08693783e+07</span> <span class="mf">1.53307970e+04</span> <span class="mf">6.57775016e+06</span> <span class="mf">1.07000000e-01</span><span class="p">]</span>
<span class="n">Reached</span> <span class="n">iteration</span> <span class="n">limit</span><span class="o">.</span> <span class="n">Previous</span> <span class="n">improvement</span><span class="p">:</span> <span class="mf">0.17</span><span class="o">%</span>
<span class="n">Minimization</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">1.87</span> <span class="n">minutes</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit1</span><span class="o">.</span><span class="n">plot_measured_clear</span><span class="p">();</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_55_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit1</span><span class="o">.</span><span class="n">plot_energy</span><span class="p">(</span><span class="n">show_clear</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_56_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit1</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">455</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_57_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">msg</span> <span class="o">=</span> <span class="s">'The system degradation rate is {:.2f}</span><span class="si">%</span><span class="s">'</span>
<span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">clear_sky_fit1</span><span class="o">.</span><span class="n">degradation_rate</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">The</span> <span class="n">system</span> <span class="n">degradation</span> <span class="n">rate</span> <span class="ow">is</span> <span class="o">-</span><span class="mf">0.69</span><span class="o">%</span></code></pre></figure>

<h3 id="appendix-b-lazy-missing-data-filling">Appendix B: lazy missing data filling</h3>

<p>Instead of linearly interpolating the daytime values in the first year, what if we had just filled with zeros everywhere?</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">power_matrix_raw</span><span class="p">)</span>
<span class="n">power_matrix_lazy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">power_matrix_raw</span><span class="p">)</span>
<span class="n">power_matrix_lazy</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">power_matrix_lazy</span> <span class="o">=</span> <span class="n">fix_time_shifts</span><span class="p">(</span><span class="n">power_matrix_lazy</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">power_matrix_lazy</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_60_0.png" alt="png" /></p>

<p>That’s not looking good. It appears that filling with zeros has caused the time shift fixing algorithm to go haywire. But just for kicks, let’s see what the statistical clear sky fitting algorithm does with the data.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit2</span> <span class="o">=</span> <span class="n">IterativeFitting</span><span class="p">(</span><span class="n">power_matrix_lazy</span><span class="p">,</span> <span class="n">rank_k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">solver_type</span><span class="o">=</span><span class="n">SolverType</span><span class="o">.</span><span class="n">mosek</span><span class="p">)</span>
<span class="n">clear_sky_fit2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mu_l</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">mu_r</span><span class="o">=</span><span class="mf">5e3</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_iteration</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">obtaining</span> <span class="n">initial</span> <span class="n">value</span> <span class="n">of</span> <span class="n">component</span> <span class="n">r0</span>
<span class="n">obtaining</span> <span class="n">weights</span>
<span class="n">starting</span> <span class="n">at</span> <span class="mf">44859059363.791</span> <span class="p">[</span><span class="mf">16796941.217175152</span><span class="p">,</span> <span class="mf">33123.42415658021</span><span class="p">,</span> <span class="mf">31713130948.786602</span><span class="p">,</span> <span class="mf">13129098350.363462</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">13499598.807</span> <span class="p">[</span><span class="mf">1.04095943e+07</span> <span class="mf">4.32879300e+03</span> <span class="mf">3.08567556e+06</span> <span class="mf">1.41000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">11469523.238</span> <span class="p">[</span><span class="mf">8.26640430e+06</span> <span class="mf">2.12687760e+04</span> <span class="mf">3.18184961e+06</span> <span class="mf">5.52000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">11282367.487</span> <span class="p">[</span><span class="mf">7.99225285e+06</span> <span class="mf">2.01813390e+04</span> <span class="mf">3.26993317e+06</span> <span class="mf">1.30000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">11161732.114</span> <span class="p">[</span><span class="mf">7.78115696e+06</span> <span class="mf">1.95071600e+04</span> <span class="mf">3.36106790e+06</span> <span class="mf">9.20000000e-02</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">11099364.419</span> <span class="p">[</span><span class="mf">7.69177366e+06</span> <span class="mf">2.01095080e+04</span> <span class="mf">3.38748090e+06</span> <span class="mf">3.43000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">11053418.574</span> <span class="p">[</span><span class="mf">7.62482854e+06</span> <span class="mf">2.04653940e+04</span> <span class="mf">3.40812429e+06</span> <span class="mf">3.56000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">7</span><span class="p">:</span> <span class="mf">11014842.209</span> <span class="p">[</span><span class="mf">7.56425030e+06</span> <span class="mf">2.10015910e+04</span> <span class="mf">3.42959007e+06</span> <span class="mf">2.41000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">8</span><span class="p">:</span> <span class="mf">10983370.431</span> <span class="p">[</span><span class="mf">7.50674275e+06</span> <span class="mf">2.09965080e+04</span> <span class="mf">3.45563113e+06</span> <span class="mf">4.40000000e-02</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">9</span><span class="p">:</span> <span class="mf">10960080.301</span> <span class="p">[</span><span class="mf">7.46898014e+06</span> <span class="mf">2.18896360e+04</span> <span class="mf">3.46921021e+06</span> <span class="mf">3.13000000e-01</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">10</span><span class="p">:</span> <span class="mf">10938321.816</span> <span class="p">[</span><span class="mf">7.43755950e+06</span> <span class="mf">2.19019410e+04</span> <span class="mf">3.47885986e+06</span> <span class="mf">5.13000000e-01</span><span class="p">]</span>
<span class="n">Reached</span> <span class="n">iteration</span> <span class="n">limit</span><span class="o">.</span> <span class="n">Previous</span> <span class="n">improvement</span><span class="p">:</span> <span class="mf">0.20</span><span class="o">%</span>
<span class="n">Minimization</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">5.60</span> <span class="n">minutes</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit2</span><span class="o">.</span><span class="n">plot_measured_clear</span><span class="p">();</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_63_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit2</span><span class="o">.</span><span class="n">plot_energy</span><span class="p">(</span><span class="n">show_clear</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_64_0.png" alt="png" /></p>

<p>We can see that the algorithm has basically ingored the first year. It selected only one day to include in the fit in the first year (orange dot), but then it treats that day as an outlier and does not utilize to understand the shape of the clear sky signal.</p>

<p>In this next plot, we see what has happened during the first year, with the zero-filled data. The algorithm has clearly ingored this part of the data set in fitting the clear sky model. You can also see the effects of the incorrect attempt at time shift fixing.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit2</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">190</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_66_0.png" alt="png" /></p>

<p>The algorithm still fits the days in the second and third years quite well:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit2</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">455</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_68_0.png" alt="png" /></p>

<p>But now we get an impossible degradation rate. The algorithm thinks that the performance of the system is <em>improving</em> by 1.07% year-over-year.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">msg</span> <span class="o">=</span> <span class="s">'The system degradation rate is {:.2f}</span><span class="si">%</span><span class="s">'</span>
<span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">clear_sky_fit2</span><span class="o">.</span><span class="n">degradation_rate</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">The</span> <span class="n">system</span> <span class="n">degradation</span> <span class="n">rate</span> <span class="ow">is</span> <span class="mf">1.07</span><span class="o">%</span></code></pre></figure>

<p>Okay, but what if we just ignore the bad year? Maybe we just need to throw that whole year out. Well, that’s a pretty bad waste of data, but we might as well try it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit3</span> <span class="o">=</span> <span class="n">IterativeFitting</span><span class="p">(</span><span class="n">power_matrix_lazy</span><span class="p">[:,</span> <span class="mi">365</span><span class="p">:],</span> <span class="n">rank_k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">solver_type</span><span class="o">=</span><span class="n">SolverType</span><span class="o">.</span><span class="n">mosek</span><span class="p">)</span>
<span class="n">clear_sky_fit3</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mu_l</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">mu_r</span><span class="o">=</span><span class="mf">5e3</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_iteration</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">obtaining</span> <span class="n">initial</span> <span class="n">value</span> <span class="n">of</span> <span class="n">component</span> <span class="n">r0</span>
<span class="n">obtaining</span> <span class="n">weights</span>
<span class="n">starting</span> <span class="n">at</span> <span class="mf">32549105845.013</span> <span class="p">[</span><span class="mf">3282668.7987403586</span><span class="p">,</span> <span class="mf">4812.206270276514</span><span class="p">,</span> <span class="mf">26873894278.2651</span><span class="p">,</span> <span class="mf">5671924085.74261</span><span class="p">]</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">142824133.761</span> <span class="p">[</span><span class="mf">1.42824134e+08</span> <span class="mf">0.00000000e+00</span> <span class="mf">0.00000000e+00</span> <span class="mf">0.00000000e+00</span><span class="p">]</span>
<span class="n">Caution</span><span class="p">:</span> <span class="n">residuals</span> <span class="n">increased</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">3836229.382</span> <span class="p">[</span><span class="mf">3.74738146e+06</span> <span class="mf">3.74454300e+03</span> <span class="mf">8.51033840e+04</span> <span class="mf">0.00000000e+00</span><span class="p">]</span>
<span class="n">Caution</span><span class="p">:</span> <span class="n">residuals</span> <span class="n">increased</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">3616954.203</span> <span class="p">[</span><span class="mf">3.5460548e+06</span> <span class="mf">2.6358250e+03</span> <span class="mf">6.8263578e+04</span> <span class="mf">0.0000000e+00</span><span class="p">]</span>
<span class="n">Caution</span><span class="p">:</span> <span class="n">residuals</span> <span class="n">increased</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">3607070.411</span> <span class="p">[</span><span class="mf">3.53543515e+06</span> <span class="mf">2.72108000e+03</span> <span class="mf">6.89141860e+04</span> <span class="mf">0.00000000e+00</span><span class="p">]</span>
<span class="n">Caution</span><span class="p">:</span> <span class="n">residuals</span> <span class="n">increased</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">3603113.893</span> <span class="p">[</span><span class="mf">3.53088803e+06</span> <span class="mf">2.52674200e+03</span> <span class="mf">6.96991240e+04</span> <span class="mf">0.00000000e+00</span><span class="p">]</span>
<span class="n">Caution</span><span class="p">:</span> <span class="n">residuals</span> <span class="n">increased</span>
<span class="n">Miminizing</span> <span class="n">left</span> <span class="n">L</span> <span class="n">matrix</span>
<span class="n">Miminizing</span> <span class="n">right</span> <span class="n">R</span> <span class="n">matrix</span>
<span class="n">iteration</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">3601105.749</span> <span class="p">[</span><span class="mf">3.52858114e+06</span> <span class="mf">2.59510600e+03</span> <span class="mf">6.99295070e+04</span> <span class="mf">0.00000000e+00</span><span class="p">]</span>
<span class="n">Caution</span><span class="p">:</span> <span class="n">residuals</span> <span class="n">increased</span>
<span class="n">Minimization</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">1.12</span> <span class="n">minutes</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit3</span><span class="o">.</span><span class="n">plot_measured_clear</span><span class="p">();</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_73_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit3</span><span class="o">.</span><span class="n">plot_energy</span><span class="p">(</span><span class="n">show_clear</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_74_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clear_sky_fit3</span><span class="o">.</span><span class="n">ts_plot</span><span class="p">(</span><span class="n">start_day</span><span class="o">=</span><span class="mi">190</span><span class="p">,</span> <span class="n">num_days</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/DataCleaning_75_0.png" alt="png" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">msg</span> <span class="o">=</span> <span class="s">'The system degradation rate is {:.2f}</span><span class="si">%</span><span class="s">'</span>
<span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">clear_sky_fit2</span><span class="o">.</span><span class="n">degradation_rate</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">The</span> <span class="n">system</span> <span class="n">degradation</span> <span class="n">rate</span> <span class="ow">is</span> <span class="mf">1.07</span><span class="o">%</span></code></pre></figure>

<p>The remaining data is too corrupted by the gaps that the algorithm cannot extract a reasonable clear sky baseline signal. Interestingly, we get the same, non-phyiscal degradation rate of +1.07%.</p>

<hr />
<p>If you’re still here, thanks for reading!</p>

:ET